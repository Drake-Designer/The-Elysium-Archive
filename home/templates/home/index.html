{% extends "base.html" %}
{% load static %}
{% load elysium_images %}
{% block title %}
  Home | The Elysium Archive
{% endblock title %}
{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/pages/home.css' %}">
{% endblock extra_css %}
{% block content %}
  <!-- Deal banner -->
  {% if deal_banners %}
    <section class="container pt-1 pb-0" aria-labelledby="deals-heading">
      <h2 id="deals-heading" class="visually-hidden">Current deals and promotions</h2>
      <div class="panel deal-banner-marquee-wrapper">
        <div class="deal-banner-marquee" role="region" aria-label="Deals ticker">
          <div class="deal-banner-marquee-track">
            {% for banner in deal_banners %}
              <a class="deal-banner-marquee-item"
                 href="{{ banner.get_url }}"
                 aria-label="{{ banner.title }}: {{ banner.message }}">
                <span class="deal-banner-marquee-icon" aria-hidden="true">{{ banner.icon }}</span>
                <span class="deal-banner-marquee-text">
                  <strong class="deal-banner-marquee-title">{{ banner.title|upper }}</strong>
                  <span class="deal-banner-marquee-message">{{ banner.message }}</span>
                  {% if banner.category %}<span class="deal-banner-marquee-badge">{{ banner.category.name }}</span>{% endif %}
                  {% if banner.discount_percentage > 0 %}
                    <span class="deal-banner-marquee-discount">-{{ banner.discount_percentage }}%</span>
                  {% endif %}
                </span>
              </a>
            {% endfor %}
            {% for banner in deal_banners %}
              <a class="deal-banner-marquee-item"
                 href="{{ banner.get_url }}"
                 aria-hidden="true"
                 tabindex="-1">
                <span class="deal-banner-marquee-icon" aria-hidden="true">{{ banner.icon }}</span>
                <span class="deal-banner-marquee-text">
                  <strong class="deal-banner-marquee-title">{{ banner.title|upper }}</strong>
                  <span class="deal-banner-marquee-message">{{ banner.message }}</span>
                  {% if banner.category %}<span class="deal-banner-marquee-badge">{{ banner.category.name }}</span>{% endif %}
                  {% if banner.discount_percentage > 0 %}
                    <span class="deal-banner-marquee-discount">-{{ banner.discount_percentage }}%</span>
                  {% endif %}
                </span>
              </a>
            {% endfor %}
          </div>
        </div>
      </div>
    </section>
  {% endif %}
  <!-- Main home layout -->
  <section class="container">
    <!-- Welcome message for logged in users -->
    {% if user.is_authenticated %}
      <div class="row">
        <div class="col-12">
          <div class="alert alert-dark text-center user-greeting-banner">
            <h2 class="h3 mb-0 user-greeting-title">
              <i class="fa-solid fa-crown me-2"></i>
              Welcome back, {{ user.profile.get_display_name }}!
            </h2>
          </div>
        </div>
      </div>
    {% endif %}
    <!-- Hero and featured entries row -->
    <div class="row g-4 align-items-center">
      <!-- Hero panel column -->
      <div class="col-12 col-lg-5">
        <div class="panel p-4 text-center hero-panel">
          <!-- Hero title and tagline -->
          <h1 class="display-5 mb-3">The Elysium Archive</h1>
          <p class="muted mb-4">
            A forbidden archive reserved for invited members only. Unlock entries and read them online forever.
          </p>
          <!-- Hero video block -->
          <div class="video-wrapper mb-3">
            <video class="video w-100"
                   loop
                   muted
                   playsinline
                   preload="metadata"
                   data-hero-video
                   aria-label="A looping corridor entrance video">
              <source src="{% static 'video/elysium-intro-video.mp4' %}" type="video/mp4">
              Your browser does not support the video tag.
            </video>
          </div>
          <!-- Hero call to action buttons -->
          <div class="d-grid gap-2">
            <a class="btn btn-primary btn-icon" href="{% url 'archive' %}">
              <i class="fa-solid fa-book-open"></i>
              Browse the Archive
            </a>
            {% if not user.is_authenticated %}
              <a class="btn btn-outline-light btn-icon" href="#membership">
                <i class="fa-solid fa-key"></i>
                Become a Member
              </a>
            {% endif %}
          </div>
          <!-- Hero footer note -->
          <p class="small muted mt-3 mb-0">No downloads. No external files. Access is the product.</p>
        </div>
      </div>
      <!-- Featured entries column -->
      <div class="col-12 col-lg-7">
        <h2 class="visually-hidden">Featured entries</h2>
        <!-- Featured carousel panel -->
        <div class="panel p-3 p-lg-4">
          {% if featured_products %}
            <!-- Bootstrap carousel wrapper -->
            <div id="entryCarousel"
                 class="carousel slide entry-carousel"
                 data-bs-ride="carousel"
                 data-bs-interval="5000"
                 data-bs-pause="hover"
                 data-bs-touch="true">
              <!-- Carousel slides -->
              <div class="carousel-inner">
                {% for product in featured_products %}
                  <!-- Single carousel item -->
                  <div class="carousel-item {% if forloop.first %}active{% endif %}">
                    <article class="entry-card entry-card--featured">
                      <!-- Entry media area -->
                      <div class="entry-card-media entry-card-media--featured">
                        {% if product.image %}
                          {% cloudinary_fill product.image 800 450 as img_src %}
                          {% cloudinary_fill_srcset product.image 400 225 600 338 800 450 as img_srcset %}
                          {% if img_src %}
                            <!-- Cloudinary image -->
                            <img class="entry-card-img"
                                 src="{{ img_src }}"
                                 srcset="{{ img_srcset }}"
                                 sizes="(max-width: 575px) 100vw,
                                        720px"
                                 alt="{{ product.image_alt|default:product.title }}"
                                 loading="eager"
                                 decoding="async"
                                 onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'entry-card-img-placeholder\' role=\'img\' aria-label=\'Image unavailable\'></div>';">
                            {% else %}
                              <!-- Fallback image -->
                              <img class="entry-card-img"
                                   src="{{ product.image.url }}"
                                   alt="{{ product.image_alt|default:product.title }}"
                                   loading="eager"
                                   decoding="async"
                                   onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\'entry-card-img-placeholder\' role=\'img\' aria-label=\'Image unavailable\'></div>';">
                              {% endif %}
                            {% else %}
                              <!-- Image placeholder -->
                              <div class="entry-card-img-placeholder"
                                   role="img"
                                   aria-label="Image unavailable"></div>
                            {% endif %}
                          </div>
                          <!-- Entry text area -->
                          <div class="entry-card-body entry-card-body--featured">
                            <div class="entry-card-head">
                              <h3 class="entry-card-title">{{ product.title }}</h3>
                              <div class="d-flex gap-2 align-items-center">
                                {% if product.is_deal %}<span class="badge badge-deal-gold">ðŸ’° DEAL</span>{% endif %}
                                <span class="badge badge-sealed">Sealed</span>
                              </div>
                            </div>
                            <p class="entry-card-desc muted">{{ product.tagline|default:product.description|truncatewords:25 }}</p>
                          </div>
                          <!-- Entry footer area -->
                          <div class="entry-card-footer entry-card-footer--featured">
                            {% if product.is_deal and product.get_discount_percentage > 0 %}
                              <div class="d-flex flex-column align-items-start">
                                <span class="small text-muted text-decoration-line-through">â‚¬{{ product.price }}</span>
                                <div class="d-flex align-items-center gap-2">
                                  <span class="price price--featured">â‚¬{{ product.get_discounted_price }}</span>
                                  <span class="badge bg-danger">-{{ product.get_discount_percentage }}%</span>
                                </div>
                              </div>
                            {% else %}
                              <span class="price price--featured">â‚¬{{ product.price }}</span>
                            {% endif %}
                            <a class="btn btn-outline-light btn-icon"
                               href="{% url 'product_detail' slug=product.slug %}">
                              <i class="fa-solid fa-eye"></i>
                              View Entry
                            </a>
                          </div>
                        </article>
                      </div>
                    {% endfor %}
                  </div>
                  <!-- Carousel indicators with navigation -->
                  <div class="d-flex align-items-center justify-content-center gap-3 mt-3 mb-0">
                    <!-- Previous button -->
                    <button class="btn btn-sm btn-outline-light section-nav-btn"
                            type="button"
                            data-bs-target="#entryCarousel"
                            data-bs-slide="prev"
                            aria-label="Previous entry">â€¹</button>
                    <!-- Dots indicators -->
                    <div class="carousel-indicators entry-carousel-dots position-static m-0">
                      {% for product in featured_products %}
                        <button type="button"
                                data-bs-target="#entryCarousel"
                                data-bs-slide-to="{{ forloop.counter0 }}"
                                {% if forloop.first %}class="active" aria-current="true"{% endif %}
                                aria-label="Slide {{ forloop.counter }}"></button>
                      {% endfor %}
                    </div>
                    <!-- Next button -->
                    <button class="btn btn-sm btn-outline-light section-nav-btn"
                            type="button"
                            data-bs-target="#entryCarousel"
                            data-bs-slide="next"
                            aria-label="Next entry">â€º</button>
                  </div>
                </div>
              {% else %}
                <!-- Empty state message -->
                <div class="text-center py-4">
                  <p class="muted mb-0">No featured entries available at the moment. Check back soon.</p>
                </div>
              {% endif %}
              <!-- Featured section note -->
              <p class="small muted mt-3 mb-0">
                These are public previews. Full entries unlock after membership and a successful payment.
              </p>
            </div>
          </div>
        </div>
        <!-- How access works section -->
        <div class="py-5" id="how-access-works">
          <h2 class="text-center mb-4">How Access Works</h2>
          <!-- Steps grid -->
          <div class="row g-3">
            <!-- Step one card -->
            <div class="col-12 col-md-4">
              <div class="panel p-4 h-100 how-card">
                <img class="how-card-img"
                     src="{% static 'img/home/how/how-01-account.jpg' %}"
                     alt="Creating an account"
                     loading="lazy"
                     decoding="async">
                <h3 class="h5 mt-3">Create an account</h3>
                <p class="muted mb-0">Register to become a member and unlock purchases to your profile.</p>
              </div>
            </div>
            <!-- Step two card -->
            <div class="col-12 col-md-4">
              <div class="panel p-4 h-100 how-card">
                <img class="how-card-img"
                     src="{% static 'img/home/how/how-02-seal.jpg' %}"
                     alt="Sealed archive entry"
                     loading="lazy"
                     decoding="async">
                <h3 class="h5 mt-3">Unlock archive entries</h3>
                <p class="muted mb-0">Pay once via Stripe and the entry becomes yours permanently.</p>
              </div>
            </div>
            <!-- Step three card -->
            <div class="col-12 col-md-4">
              <div class="panel p-4 h-100 how-card">
                <img class="how-card-img"
                     src="{% static 'img/home/how/how-03-library.jpg' %}"
                     alt="Private archive library"
                     loading="lazy"
                     decoding="async">
                <h3 class="h5 mt-3">Access your private archive</h3>
                <p class="muted mb-0">Read exclusive content online only, anytime you return.</p>
              </div>
            </div>
          </div>
        </div>
        <!-- Membership section -->
        <div class="py-5" id="membership">
          <h2 class="text-center mb-3">Membership</h2>
          <p class="text-center muted mb-4">
            Membership is required to unlock entries. Your access is tied to your account, not to a file.
          </p>
          <!-- Membership panel -->
          <div class="panel p-4 p-lg-5">
            <!-- Membership layout row -->
            <div class="row g-4 align-items-center">
              <!-- Membership image column -->
              <div class="col-12 col-lg-5">
                <div class="membership-media">
                  <img class="membership-img"
                       src="{% static 'img/home/membership/membership.jpg' %}"
                       alt="Membership access"
                       loading="lazy"
                       decoding="async">
                </div>
              </div>
              <!-- Membership content column -->
              <div class="col-12 col-lg-7">
                <!-- Membership benefits list -->
                <ul class="mb-4">
                  <li class="muted">Buy once, access forever on site</li>
                  <li class="muted">Unlocked entries live in your private archive</li>
                  <li class="muted">Verified buyers can leave reviews</li>
                  <li class="muted">No refunds after access is unlocked</li>
                </ul>
                <!-- Membership actions panel -->
                <div class="panel p-4">
                  {% if user.is_authenticated %}
                    <!-- Member state -->
                    <h3 class="h4 mb-3">
                      <strong>Welcome back, {{ user.profile.get_display_name }}!</strong>
                    </h3>
                    <p class="muted mb-3">You are a member of the Archive. Explore and unlock forbidden knowledge.</p>
                    <div class="d-grid gap-2 d-sm-flex">
                      <a class="btn btn-primary site-auth-btn btn-icon"
                         href="{% url 'archive' %}">
                        <i class="fa-solid fa-book-open"></i>
                        Browse Entries
                      </a>
                    </div>
                  {% else %}
                    <!-- Guest state -->
                    <h3 class="h5 mb-2">Ready to enter?</h3>
                    <p class="muted mb-3">Create an account to unlock archive entries and build your collection.</p>
                    <div class="d-grid gap-2 d-sm-flex">
                      <a class="btn btn-primary site-auth-btn btn-icon"
                         href="{% url 'account_signup' %}">
                        <i class="fa-solid fa-user-plus"></i>
                        Register
                      </a>
                      <a class="btn btn-outline-light site-auth-btn btn-icon"
                         href="{% url 'account_login' %}">
                        <i class="fa-solid fa-right-to-bracket"></i>
                        Login
                      </a>
                    </div>
                  {% endif %}
                  <!-- Membership footer note -->
                  <p class="small muted mt-3 mb-0">You can browse the public catalog without an account.</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Upcoming features section -->
        <div class="py-5" id="coming-next">
          <h2 class="text-center mb-3">What Lies Ahead</h2>
          <p class="text-center muted mb-4">The Archive continues to expand. New secrets await those who remain patient.</p>
          <!-- Upcoming features grid -->
          <div class="row g-3">
            <!-- My Archive card -->
            <div class="col-12 col-sm-6 col-lg-3">
              <div class="panel p-4 h-100 coming-card">
                <div class="coming-card-icon">
                  <i class="fa-solid fa-vault"></i>
                </div>
                <h3 class="h5 mt-3 mb-2">My Archive</h3>
                <p class="small muted mb-3">Your private vault where unlocked entries live forever.</p>
                <div class="card-actions">
                  {% if request.user.is_authenticated and user_is_verified %}
                    <a href="{% url 'my_archive' %}" class="btn btn-outline-light btn-icon">
                      <i class="fa-solid fa-folder-open"></i>
                      Open My Archive
                    </a>
                  {% else %}
                    <a href="{% url 'account_login' %}"
                       class="btn btn-outline-light btn-icon">
                      <i class="fa-solid fa-right-to-bracket"></i>
                      Sign in to access
                    </a>
                  {% endif %}
                </div>
              </div>
            </div>
            <!-- Verified Reviews card -->
            <div class="col-12 col-sm-6 col-lg-3">
              <div class="panel p-4 h-100 coming-card">
                <div class="coming-card-icon">
                  <i class="fa-solid fa-star"></i>
                </div>
                <h3 class="h5 mt-3 mb-2">Verified Reviews</h3>
                <p class="small muted mb-3">Read reviews on each entry. Verified buyers can leave one review per entry.</p>
                <div class="card-actions">
                  <a href="{% url 'archive' %}" class="btn btn-outline-light btn-icon">
                    <i class="fa-solid fa-list"></i>
                    Browse entries
                  </a>
                </div>
              </div>
            </div>
            <!-- Profile Management card -->
            <div class="col-12 col-sm-6 col-lg-3">
              <div class="panel p-4 h-100 coming-card">
                <div class="coming-card-icon">
                  <i class="fa-solid fa-user-gear"></i>
                </div>
                <h3 class="h5 mt-3 mb-2">Profile Management</h3>
                <p class="small muted mb-3">Control your identity, manage email, password, and account settings.</p>
                <div class="card-actions">
                  {% if request.user.is_authenticated %}
                    <a href="{% url 'profile' %}" class="btn btn-outline-light btn-icon">
                      <i class="fa-solid fa-user"></i>
                      Open Profile
                    </a>
                  {% else %}
                    <a href="{% url 'account_signup' %}"
                       class="btn btn-outline-light btn-icon">
                      <i class="fa-solid fa-user-plus"></i>
                      Create an account
                    </a>
                  {% endif %}
                </div>
              </div>
            </div>
            <!-- Lore card -->
            <div class="col-12 col-sm-6 col-lg-3">
              <div class="panel p-4 h-100 coming-card">
                <div class="coming-card-icon">
                  <i class="fa-solid fa-book-skull"></i>
                </div>
                <h3 class="h5 mt-3 mb-2">Lore</h3>
                <p class="small muted mb-3">Explore the Archive's world-building, histories, and dark tales.</p>
                <div class="card-actions">
                  <a href="{% url 'lore' %}" class="btn btn-outline-light btn-icon">
                    <i class="fa-solid fa-scroll-old"></i>
                    Explore lore
                  </a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
    {% endblock content %}
