{% extends "base.html" %}
{% block title %}
    Delete Account | The Elysium Archive
{% endblock title %}
{% block content %}
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="panel p-4">
                    <h1 class="h3 mb-4">Delete My Account</h1>
                    <div class="alert alert-danger">
                        <i class="fa-solid fa-triangle-exclamation me-2"></i>
                        <strong>Warning:</strong> This action cannot be undone. All your data will be permanently deleted.
                    </div>
                    {# Il form esiste ancora ma verrà sottomesso solo dal modale #}
                    <form method="post" id="deleteAccountForm">
                        {% csrf_token %}
                        <div class="d-grid gap-2">
                            {# Bottone che apre il modale di conferma #}
                            <button type="button" class="btn btn-danger" id="openDeleteAccountModalBtn">
                                <i class="fa-solid fa-trash me-2"></i>Delete My Account
                            </button>
                            <a href="{% url 'account_dashboard' %}" class="btn btn-secondary">
                                <i class="fa-solid fa-arrow-left me-2"></i>Cancel
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {# Modale di conferma Bootstrap #}
    <div class="modal fade"
         id="deleteAccountConfirmModal"
         tabindex="-1"
         aria-labelledby="deleteAccountConfirmModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark border-danger">
                <div class="modal-header border-0">
                    <h2 class="h5 modal-title" id="deleteAccountConfirmModalLabel">
                        <i class="fa-solid fa-trash me-2 text-danger"></i>
                        Confirm Account Deletion
                    </h2>
                    <button type="button"
                            class="btn-close btn-close-white"
                            data-bs-dismiss="modal"
                            aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="mb-2">This will permanently delete your account, purchase history and access to unlocked entries.</p>
                    <p class="text-danger mb-0">This action cannot be undone. Are you absolutely sure you want to continue?</p>
                </div>
                <div class="modal-footer border-0 d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fa-solid fa-arrow-left me-2"></i>Cancel
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteAccountBtn">
                        <i class="fa-solid fa-trash me-2"></i>Yes, delete my account
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}
{% block extra_js %}
    {{ block.super }}
    <script>
        (function () {
            'use strict';

            const initDeleteAccountModal = () => {
                const openBtn = document.getElementById('openDeleteAccountModalBtn');
                const confirmBtn = document.getElementById('confirmDeleteAccountBtn');
                const form = document.getElementById('deleteAccountForm');
                const modalEl = document.getElementById('deleteAccountConfirmModal');

                if (!openBtn || !confirmBtn || !form || !modalEl) {
                    return;
                }

                const modal = new bootstrap.Modal(modalEl);

                // Apre il modale quando l’utente clicca il bottone principale
                openBtn.addEventListener('click', () => {
                    modal.show();
                });

                // Solo qui viene inviato definitivamente il form
                confirmBtn.addEventListener('click', () => {
                    form.submit();
                });
            };

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initDeleteAccountModal);
            } else {
                initDeleteAccountModal();
            }
        })();
    </script>
{% endblock extra_js %}
